{"ast":null,"code":"/*\r\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\r\n * the License. A copy of the License is located at\r\n *\r\n *     http://aws.amazon.com/apache2.0/\r\n *\r\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\r\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\r\n * and limitations under the License.\r\n */\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) {\n        if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n      }\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) {\n    s += arguments[i].length;\n  }\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) {\n    for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) {\n      r[k] = a[j];\n    }\n  }\n\n  return r;\n};\n\nimport { ConsoleLogger as Logger } from './Logger';\nvar logger = new Logger('Hub');\nvar AMPLIFY_SYMBOL = typeof Symbol !== 'undefined' && typeof Symbol.for === 'function' ? Symbol.for('amplify_default') : '@@amplify_default';\n\nfunction isLegacyCallback(callback) {\n  return callback.onHubCapsule !== undefined;\n}\n\nvar HubClass =\n/** @class */\nfunction () {\n  function HubClass(name) {\n    this.listeners = [];\n    this.patterns = [];\n    this.protectedChannels = ['core', 'auth', 'api', 'analytics', 'interactions', 'pubsub', 'storage', 'xr'];\n    this.name = name;\n  } // Note - Need to pass channel as a reference for removal to work and not anonymous function\n\n\n  HubClass.prototype.remove = function (channel, listener) {\n    if (channel instanceof RegExp) {\n      var pattern_1 = this.patterns.find(function (_a) {\n        var pattern = _a.pattern;\n        return pattern.source === channel.source;\n      });\n\n      if (!pattern_1) {\n        logger.warn(\"No listeners for \" + channel);\n        return;\n      }\n\n      this.patterns = __spreadArrays(this.patterns.filter(function (x) {\n        return x !== pattern_1;\n      }));\n    } else {\n      var holder = this.listeners[channel];\n\n      if (!holder) {\n        logger.warn(\"No listeners for \" + channel);\n        return;\n      }\n\n      this.listeners[channel] = __spreadArrays(holder.filter(function (_a) {\n        var callback = _a.callback;\n        return callback !== listener;\n      }));\n    }\n  };\n\n  HubClass.prototype.dispatch = function (channel, payload, source, ampSymbol) {\n    if (source === void 0) {\n      source = '';\n    }\n\n    if (this.protectedChannels.indexOf(channel) > -1) {\n      var hasAccess = ampSymbol === AMPLIFY_SYMBOL;\n\n      if (!hasAccess) {\n        logger.warn(\"WARNING: \" + channel + \" is protected and dispatching on it can have unintended consequences\");\n      }\n    }\n\n    var capsule = {\n      channel: channel,\n      payload: __assign({}, payload),\n      source: source,\n      patternInfo: []\n    };\n\n    try {\n      this._toListeners(capsule);\n    } catch (e) {\n      logger.error(e);\n    }\n  };\n\n  HubClass.prototype.listen = function (channel, callback, listenerName) {\n    if (listenerName === void 0) {\n      listenerName = 'noname';\n    }\n\n    var cb; // Check for legacy onHubCapsule callback for backwards compatability\n\n    if (isLegacyCallback(callback)) {\n      logger.warn(\"WARNING onHubCapsule is Deprecated. Please pass in a callback.\");\n      cb = callback.onHubCapsule.bind(callback);\n    } else if (typeof callback !== 'function') {\n      throw new Error('No callback supplied to Hub');\n    } else {\n      cb = callback;\n    }\n\n    if (channel instanceof RegExp) {\n      this.patterns.push({\n        pattern: channel,\n        callback: cb\n      });\n    } else {\n      var holder = this.listeners[channel];\n\n      if (!holder) {\n        holder = [];\n        this.listeners[channel] = holder;\n      }\n\n      holder.push({\n        name: listenerName,\n        callback: cb\n      });\n    }\n  };\n\n  HubClass.prototype._toListeners = function (capsule) {\n    var channel = capsule.channel,\n        payload = capsule.payload;\n    var holder = this.listeners[channel];\n\n    if (holder) {\n      holder.forEach(function (listener) {\n        logger.debug(\"Dispatching to \" + channel + \" with \", payload);\n\n        try {\n          listener.callback(capsule);\n        } catch (e) {\n          logger.error(e);\n        }\n      });\n    }\n\n    if (this.patterns.length > 0) {\n      if (!payload.message) {\n        logger.warn(\"Cannot perform pattern matching without a message key\");\n        return;\n      }\n\n      var payloadStr_1 = payload.message;\n      this.patterns.forEach(function (pattern) {\n        var match = payloadStr_1.match(pattern.pattern);\n\n        if (match) {\n          var groups = match.slice(1);\n\n          var dispatchingCapsule = __assign(__assign({}, capsule), {\n            patternInfo: groups\n          });\n\n          try {\n            pattern.callback(dispatchingCapsule);\n          } catch (e) {\n            logger.error(e);\n          }\n        }\n      });\n    }\n  };\n\n  return HubClass;\n}();\n\nexport { HubClass };\n/*We export a __default__ instance of HubClass to use it as a\r\npsuedo Singleton for the main messaging bus, however you can still create\r\nyour own instance of HubClass() for a separate \"private bus\" of events.*/\n\nvar Hub = new HubClass('__default__');\nexport default Hub;","map":{"version":3,"sources":["../src/Hub.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/*\r\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\r\n * the License. A copy of the License is located at\r\n *\r\n *     http://aws.amazon.com/apache2.0/\r\n *\r\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\r\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\r\n * and limitations under the License.\r\n */\r\nvar __assign = (this && this.__assign) || function () {\r\n    __assign = Object.assign || function(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n                t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\nimport { ConsoleLogger as Logger } from './Logger';\r\nvar logger = new Logger('Hub');\r\nvar AMPLIFY_SYMBOL = (typeof Symbol !== 'undefined' &&\r\n    typeof Symbol.for === 'function'\r\n    ? Symbol.for('amplify_default')\r\n    : '@@amplify_default');\r\nfunction isLegacyCallback(callback) {\r\n    return callback.onHubCapsule !== undefined;\r\n}\r\nvar HubClass = /** @class */ (function () {\r\n    function HubClass(name) {\r\n        this.listeners = [];\r\n        this.patterns = [];\r\n        this.protectedChannels = [\r\n            'core',\r\n            'auth',\r\n            'api',\r\n            'analytics',\r\n            'interactions',\r\n            'pubsub',\r\n            'storage',\r\n            'xr',\r\n        ];\r\n        this.name = name;\r\n    }\r\n    // Note - Need to pass channel as a reference for removal to work and not anonymous function\r\n    HubClass.prototype.remove = function (channel, listener) {\r\n        if (channel instanceof RegExp) {\r\n            var pattern_1 = this.patterns.find(function (_a) {\r\n                var pattern = _a.pattern;\r\n                return pattern.source === channel.source;\r\n            });\r\n            if (!pattern_1) {\r\n                logger.warn(\"No listeners for \" + channel);\r\n                return;\r\n            }\r\n            this.patterns = __spreadArrays(this.patterns.filter(function (x) { return x !== pattern_1; }));\r\n        }\r\n        else {\r\n            var holder = this.listeners[channel];\r\n            if (!holder) {\r\n                logger.warn(\"No listeners for \" + channel);\r\n                return;\r\n            }\r\n            this.listeners[channel] = __spreadArrays(holder.filter(function (_a) {\r\n                var callback = _a.callback;\r\n                return callback !== listener;\r\n            }));\r\n        }\r\n    };\r\n    HubClass.prototype.dispatch = function (channel, payload, source, ampSymbol) {\r\n        if (source === void 0) { source = ''; }\r\n        if (this.protectedChannels.indexOf(channel) > -1) {\r\n            var hasAccess = ampSymbol === AMPLIFY_SYMBOL;\r\n            if (!hasAccess) {\r\n                logger.warn(\"WARNING: \" + channel + \" is protected and dispatching on it can have unintended consequences\");\r\n            }\r\n        }\r\n        var capsule = {\r\n            channel: channel,\r\n            payload: __assign({}, payload),\r\n            source: source,\r\n            patternInfo: [],\r\n        };\r\n        try {\r\n            this._toListeners(capsule);\r\n        }\r\n        catch (e) {\r\n            logger.error(e);\r\n        }\r\n    };\r\n    HubClass.prototype.listen = function (channel, callback, listenerName) {\r\n        if (listenerName === void 0) { listenerName = 'noname'; }\r\n        var cb;\r\n        // Check for legacy onHubCapsule callback for backwards compatability\r\n        if (isLegacyCallback(callback)) {\r\n            logger.warn(\"WARNING onHubCapsule is Deprecated. Please pass in a callback.\");\r\n            cb = callback.onHubCapsule.bind(callback);\r\n        }\r\n        else if (typeof callback !== 'function') {\r\n            throw new Error('No callback supplied to Hub');\r\n        }\r\n        else {\r\n            cb = callback;\r\n        }\r\n        if (channel instanceof RegExp) {\r\n            this.patterns.push({\r\n                pattern: channel,\r\n                callback: cb,\r\n            });\r\n        }\r\n        else {\r\n            var holder = this.listeners[channel];\r\n            if (!holder) {\r\n                holder = [];\r\n                this.listeners[channel] = holder;\r\n            }\r\n            holder.push({\r\n                name: listenerName,\r\n                callback: cb,\r\n            });\r\n        }\r\n    };\r\n    HubClass.prototype._toListeners = function (capsule) {\r\n        var channel = capsule.channel, payload = capsule.payload;\r\n        var holder = this.listeners[channel];\r\n        if (holder) {\r\n            holder.forEach(function (listener) {\r\n                logger.debug(\"Dispatching to \" + channel + \" with \", payload);\r\n                try {\r\n                    listener.callback(capsule);\r\n                }\r\n                catch (e) {\r\n                    logger.error(e);\r\n                }\r\n            });\r\n        }\r\n        if (this.patterns.length > 0) {\r\n            if (!payload.message) {\r\n                logger.warn(\"Cannot perform pattern matching without a message key\");\r\n                return;\r\n            }\r\n            var payloadStr_1 = payload.message;\r\n            this.patterns.forEach(function (pattern) {\r\n                var match = payloadStr_1.match(pattern.pattern);\r\n                if (match) {\r\n                    var groups = match.slice(1);\r\n                    var dispatchingCapsule = __assign(__assign({}, capsule), { patternInfo: groups });\r\n                    try {\r\n                        pattern.callback(dispatchingCapsule);\r\n                    }\r\n                    catch (e) {\r\n                        logger.error(e);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    };\r\n    return HubClass;\r\n}());\r\nexport { HubClass };\r\n/*We export a __default__ instance of HubClass to use it as a\r\npsuedo Singleton for the main messaging bus, however you can still create\r\nyour own instance of HubClass() for a separate \"private bus\" of events.*/\r\nvar Hub = new HubClass('__default__');\r\nexport default Hub;\r\n//# sourceMappingURL=Hub.js.map"]},"metadata":{},"sourceType":"module"}