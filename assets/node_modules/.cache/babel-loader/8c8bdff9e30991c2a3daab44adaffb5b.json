{"ast":null,"code":"/*\r\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\r\n * the License. A copy of the License is located at\r\n *\r\n *     http://aws.amazon.com/apache2.0/\r\n *\r\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\r\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\r\n * and limitations under the License.\r\n */\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function sent() {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) {\n      try {\n        if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n        if (y = 0, t) op = [op[0] & 2, t.value];\n\n        switch (op[0]) {\n          case 0:\n          case 1:\n            t = op;\n            break;\n\n          case 4:\n            _.label++;\n            return {\n              value: op[1],\n              done: false\n            };\n\n          case 5:\n            _.label++;\n            y = op[1];\n            op = [0];\n            continue;\n\n          case 7:\n            op = _.ops.pop();\n\n            _.trys.pop();\n\n            continue;\n\n          default:\n            if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n              _ = 0;\n              continue;\n            }\n\n            if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n              _.label = op[1];\n              break;\n            }\n\n            if (op[0] === 6 && _.label < t[1]) {\n              _.label = t[1];\n              t = op;\n              break;\n            }\n\n            if (t && _.label < t[2]) {\n              _.label = t[2];\n\n              _.ops.push(op);\n\n              break;\n            }\n\n            if (t[2]) _.ops.pop();\n\n            _.trys.pop();\n\n            continue;\n        }\n\n        op = body.call(thisArg, _);\n      } catch (e) {\n        op = [6, e];\n        y = 0;\n      } finally {\n        f = t = 0;\n      }\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nimport { ConsoleLogger as Logger, Credentials } from '@aws-amplify/core';\nimport * as Kinesis from 'aws-sdk/clients/kinesis';\nvar logger = new Logger('AWSKineisProvider'); // events buffer\n\nvar BUFFER_SIZE = 1000;\nvar FLUSH_SIZE = 100;\nvar FLUSH_INTERVAL = 5 * 1000; // 5s\n\nvar RESEND_LIMIT = 5;\n\nvar AWSKinesisProvider =\n/** @class */\nfunction () {\n  function AWSKinesisProvider(config) {\n    this._buffer = [];\n    this._config = config ? config : {};\n    this._config.bufferSize = this._config.bufferSize || BUFFER_SIZE;\n    this._config.flushSize = this._config.flushSize || FLUSH_SIZE;\n    this._config.flushInterval = this._config.flushInterval || FLUSH_INTERVAL;\n    this._config.resendLimit = this._config.resendLimit || RESEND_LIMIT; // events batch\n\n    var that = this; // flush event buffer\n\n    this._setupTimer();\n  }\n\n  AWSKinesisProvider.prototype._setupTimer = function () {\n    var _this = this;\n\n    if (this._timer) {\n      clearInterval(this._timer);\n    }\n\n    var _a = this._config,\n        flushSize = _a.flushSize,\n        flushInterval = _a.flushInterval;\n    var that = this;\n    this._timer = setInterval(function () {\n      var size = _this._buffer.length < flushSize ? _this._buffer.length : flushSize;\n      var events = [];\n\n      for (var i = 0; i < size; i += 1) {\n        var params = _this._buffer.shift();\n\n        events.push(params);\n      }\n\n      that._sendFromBuffer(events);\n    }, flushInterval);\n  };\n  /**\r\n   * get the category of the plugin\r\n   */\n\n\n  AWSKinesisProvider.prototype.getCategory = function () {\n    return 'Analytics';\n  };\n  /**\r\n   * get provider name of the plugin\r\n   */\n\n\n  AWSKinesisProvider.prototype.getProviderName = function () {\n    return 'AWSKinesis';\n  };\n  /**\r\n   * configure the plugin\r\n   * @param {Object} config - configuration\r\n   */\n\n\n  AWSKinesisProvider.prototype.configure = function (config) {\n    logger.debug('configure Analytics', config);\n    var conf = config ? config : {};\n    this._config = Object.assign({}, this._config, conf);\n\n    this._setupTimer();\n\n    return this._config;\n  };\n  /**\r\n   * record an event\r\n   * @param {Object} params - the params of an event\r\n   */\n\n\n  AWSKinesisProvider.prototype.record = function (params) {\n    return __awaiter(this, void 0, void 0, function () {\n      var credentials;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this._getCredentials()];\n\n          case 1:\n            credentials = _a.sent();\n            if (!credentials) return [2\n            /*return*/\n            , Promise.resolve(false)];\n            Object.assign(params, {\n              config: this._config,\n              credentials: credentials\n            });\n            return [2\n            /*return*/\n            , this._putToBuffer(params)];\n        }\n      });\n    });\n  };\n\n  AWSKinesisProvider.prototype.updateEndpoint = function (params) {\n    logger.debug('updateEndpoint is not implemented in Kinesis provider');\n    return Promise.resolve(true);\n  };\n  /**\r\n   * @private\r\n   * @param params - params for the event recording\r\n   * Put events into buffer\r\n   */\n\n\n  AWSKinesisProvider.prototype._putToBuffer = function (params) {\n    if (this._buffer.length < BUFFER_SIZE) {\n      this._buffer.push(params);\n\n      return Promise.resolve(true);\n    } else {\n      logger.debug('exceed analytics events buffer size');\n      return Promise.reject(false);\n    }\n  };\n\n  AWSKinesisProvider.prototype._sendFromBuffer = function (events) {\n    var _this = this; // collapse events by credentials\n    // events = [ {params} ]\n\n\n    var eventsGroups = [];\n    var preCred = null;\n    var group = [];\n\n    for (var i = 0; i < events.length; i += 1) {\n      var cred = events[i].credentials;\n\n      if (i === 0) {\n        group.push(events[i]);\n        preCred = cred;\n      } else {\n        if (cred.sessionToken === preCred.sessionToken && cred.identityId === preCred.identityId) {\n          logger.debug('no change for cred, put event in the same group');\n          group.push(events[i]);\n        } else {\n          eventsGroups.push(group);\n          group = [];\n          group.push(events[i]);\n          preCred = cred;\n        }\n      }\n    }\n\n    eventsGroups.push(group);\n    eventsGroups.map(function (evts) {\n      _this._sendEvents(evts);\n    });\n  };\n\n  AWSKinesisProvider.prototype._sendEvents = function (group) {\n    var _this = this;\n\n    if (group.length === 0) {\n      // logger.debug('events array is empty, directly return');\n      return;\n    }\n\n    var _a = group[0],\n        config = _a.config,\n        credentials = _a.credentials;\n\n    var initClients = this._init(config, credentials);\n\n    if (!initClients) return false;\n    var records = {};\n    group.map(function (params) {\n      // spit by streamName\n      var evt = params.event;\n      var streamName = evt.streamName;\n\n      if (records[streamName] === undefined) {\n        records[streamName] = [];\n      }\n\n      var Data = JSON.stringify(evt.data);\n      var PartitionKey = evt.partitionKey || 'partition-' + credentials.identityId;\n      var record = {\n        Data: Data,\n        PartitionKey: PartitionKey\n      };\n      records[streamName].push(record);\n    });\n    Object.keys(records).map(function (streamName) {\n      logger.debug('putting records to kinesis with records', records[streamName]);\n\n      _this._kinesis.putRecords({\n        Records: records[streamName],\n        StreamName: streamName\n      }, function (err, data) {\n        if (err) logger.debug('Failed to upload records to Kinesis', err);else logger.debug('Upload records to stream', streamName);\n      });\n    });\n  };\n\n  AWSKinesisProvider.prototype._init = function (config, credentials) {\n    logger.debug('init clients');\n\n    if (this._kinesis && this._config.credentials && this._config.credentials.sessionToken === credentials.sessionToken && this._config.credentials.identityId === credentials.identityId) {\n      logger.debug('no change for analytics config, directly return from init');\n      return true;\n    }\n\n    this._config.credentials = credentials;\n    var region = config.region;\n    logger.debug('initialize kinesis with credentials', credentials);\n    this._kinesis = new Kinesis({\n      apiVersion: '2013-12-02',\n      region: region,\n      credentials: credentials\n    });\n    return true;\n  };\n  /**\r\n   * @private\r\n   * check if current credentials exists\r\n   */\n\n\n  AWSKinesisProvider.prototype._getCredentials = function () {\n    var that = this;\n    return Credentials.get().then(function (credentials) {\n      if (!credentials) return null;\n      logger.debug('set credentials for analytics', that._config.credentials);\n      return Credentials.shear(credentials);\n    }).catch(function (err) {\n      logger.debug('ensure credentials error', err);\n      return null;\n    });\n  };\n\n  return AWSKinesisProvider;\n}();\n\nexport default AWSKinesisProvider;","map":{"version":3,"sources":["../../src/Providers/AWSKinesisProvider.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["/*\r\n * Copyright 2017-2017 Amazon.com, Inc. or its affiliates. All Rights Reserved.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\"). You may not use this file except in compliance with\r\n * the License. A copy of the License is located at\r\n *\r\n *     http://aws.amazon.com/apache2.0/\r\n *\r\n * or in the \"license\" file accompanying this file. This file is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR\r\n * CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions\r\n * and limitations under the License.\r\n */\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nimport { ConsoleLogger as Logger, Credentials } from '@aws-amplify/core';\r\nimport * as Kinesis from 'aws-sdk/clients/kinesis';\r\nvar logger = new Logger('AWSKineisProvider');\r\n// events buffer\r\nvar BUFFER_SIZE = 1000;\r\nvar FLUSH_SIZE = 100;\r\nvar FLUSH_INTERVAL = 5 * 1000; // 5s\r\nvar RESEND_LIMIT = 5;\r\nvar AWSKinesisProvider = /** @class */ (function () {\r\n    function AWSKinesisProvider(config) {\r\n        this._buffer = [];\r\n        this._config = config ? config : {};\r\n        this._config.bufferSize = this._config.bufferSize || BUFFER_SIZE;\r\n        this._config.flushSize = this._config.flushSize || FLUSH_SIZE;\r\n        this._config.flushInterval = this._config.flushInterval || FLUSH_INTERVAL;\r\n        this._config.resendLimit = this._config.resendLimit || RESEND_LIMIT;\r\n        // events batch\r\n        var that = this;\r\n        // flush event buffer\r\n        this._setupTimer();\r\n    }\r\n    AWSKinesisProvider.prototype._setupTimer = function () {\r\n        var _this = this;\r\n        if (this._timer) {\r\n            clearInterval(this._timer);\r\n        }\r\n        var _a = this._config, flushSize = _a.flushSize, flushInterval = _a.flushInterval;\r\n        var that = this;\r\n        this._timer = setInterval(function () {\r\n            var size = _this._buffer.length < flushSize ? _this._buffer.length : flushSize;\r\n            var events = [];\r\n            for (var i = 0; i < size; i += 1) {\r\n                var params = _this._buffer.shift();\r\n                events.push(params);\r\n            }\r\n            that._sendFromBuffer(events);\r\n        }, flushInterval);\r\n    };\r\n    /**\r\n     * get the category of the plugin\r\n     */\r\n    AWSKinesisProvider.prototype.getCategory = function () {\r\n        return 'Analytics';\r\n    };\r\n    /**\r\n     * get provider name of the plugin\r\n     */\r\n    AWSKinesisProvider.prototype.getProviderName = function () {\r\n        return 'AWSKinesis';\r\n    };\r\n    /**\r\n     * configure the plugin\r\n     * @param {Object} config - configuration\r\n     */\r\n    AWSKinesisProvider.prototype.configure = function (config) {\r\n        logger.debug('configure Analytics', config);\r\n        var conf = config ? config : {};\r\n        this._config = Object.assign({}, this._config, conf);\r\n        this._setupTimer();\r\n        return this._config;\r\n    };\r\n    /**\r\n     * record an event\r\n     * @param {Object} params - the params of an event\r\n     */\r\n    AWSKinesisProvider.prototype.record = function (params) {\r\n        return __awaiter(this, void 0, void 0, function () {\r\n            var credentials;\r\n            return __generator(this, function (_a) {\r\n                switch (_a.label) {\r\n                    case 0: return [4 /*yield*/, this._getCredentials()];\r\n                    case 1:\r\n                        credentials = _a.sent();\r\n                        if (!credentials)\r\n                            return [2 /*return*/, Promise.resolve(false)];\r\n                        Object.assign(params, { config: this._config, credentials: credentials });\r\n                        return [2 /*return*/, this._putToBuffer(params)];\r\n                }\r\n            });\r\n        });\r\n    };\r\n    AWSKinesisProvider.prototype.updateEndpoint = function (params) {\r\n        logger.debug('updateEndpoint is not implemented in Kinesis provider');\r\n        return Promise.resolve(true);\r\n    };\r\n    /**\r\n     * @private\r\n     * @param params - params for the event recording\r\n     * Put events into buffer\r\n     */\r\n    AWSKinesisProvider.prototype._putToBuffer = function (params) {\r\n        if (this._buffer.length < BUFFER_SIZE) {\r\n            this._buffer.push(params);\r\n            return Promise.resolve(true);\r\n        }\r\n        else {\r\n            logger.debug('exceed analytics events buffer size');\r\n            return Promise.reject(false);\r\n        }\r\n    };\r\n    AWSKinesisProvider.prototype._sendFromBuffer = function (events) {\r\n        var _this = this;\r\n        // collapse events by credentials\r\n        // events = [ {params} ]\r\n        var eventsGroups = [];\r\n        var preCred = null;\r\n        var group = [];\r\n        for (var i = 0; i < events.length; i += 1) {\r\n            var cred = events[i].credentials;\r\n            if (i === 0) {\r\n                group.push(events[i]);\r\n                preCred = cred;\r\n            }\r\n            else {\r\n                if (cred.sessionToken === preCred.sessionToken &&\r\n                    cred.identityId === preCred.identityId) {\r\n                    logger.debug('no change for cred, put event in the same group');\r\n                    group.push(events[i]);\r\n                }\r\n                else {\r\n                    eventsGroups.push(group);\r\n                    group = [];\r\n                    group.push(events[i]);\r\n                    preCred = cred;\r\n                }\r\n            }\r\n        }\r\n        eventsGroups.push(group);\r\n        eventsGroups.map(function (evts) {\r\n            _this._sendEvents(evts);\r\n        });\r\n    };\r\n    AWSKinesisProvider.prototype._sendEvents = function (group) {\r\n        var _this = this;\r\n        if (group.length === 0) {\r\n            // logger.debug('events array is empty, directly return');\r\n            return;\r\n        }\r\n        var _a = group[0], config = _a.config, credentials = _a.credentials;\r\n        var initClients = this._init(config, credentials);\r\n        if (!initClients)\r\n            return false;\r\n        var records = {};\r\n        group.map(function (params) {\r\n            // spit by streamName\r\n            var evt = params.event;\r\n            var streamName = evt.streamName;\r\n            if (records[streamName] === undefined) {\r\n                records[streamName] = [];\r\n            }\r\n            var Data = JSON.stringify(evt.data);\r\n            var PartitionKey = evt.partitionKey || 'partition-' + credentials.identityId;\r\n            var record = { Data: Data, PartitionKey: PartitionKey };\r\n            records[streamName].push(record);\r\n        });\r\n        Object.keys(records).map(function (streamName) {\r\n            logger.debug('putting records to kinesis with records', records[streamName]);\r\n            _this._kinesis.putRecords({\r\n                Records: records[streamName],\r\n                StreamName: streamName,\r\n            }, function (err, data) {\r\n                if (err)\r\n                    logger.debug('Failed to upload records to Kinesis', err);\r\n                else\r\n                    logger.debug('Upload records to stream', streamName);\r\n            });\r\n        });\r\n    };\r\n    AWSKinesisProvider.prototype._init = function (config, credentials) {\r\n        logger.debug('init clients');\r\n        if (this._kinesis &&\r\n            this._config.credentials &&\r\n            this._config.credentials.sessionToken === credentials.sessionToken &&\r\n            this._config.credentials.identityId === credentials.identityId) {\r\n            logger.debug('no change for analytics config, directly return from init');\r\n            return true;\r\n        }\r\n        this._config.credentials = credentials;\r\n        var region = config.region;\r\n        logger.debug('initialize kinesis with credentials', credentials);\r\n        this._kinesis = new Kinesis({\r\n            apiVersion: '2013-12-02',\r\n            region: region,\r\n            credentials: credentials,\r\n        });\r\n        return true;\r\n    };\r\n    /**\r\n     * @private\r\n     * check if current credentials exists\r\n     */\r\n    AWSKinesisProvider.prototype._getCredentials = function () {\r\n        var that = this;\r\n        return Credentials.get()\r\n            .then(function (credentials) {\r\n            if (!credentials)\r\n                return null;\r\n            logger.debug('set credentials for analytics', that._config.credentials);\r\n            return Credentials.shear(credentials);\r\n        })\r\n            .catch(function (err) {\r\n            logger.debug('ensure credentials error', err);\r\n            return null;\r\n        });\r\n    };\r\n    return AWSKinesisProvider;\r\n}());\r\nexport default AWSKinesisProvider;\r\n//# sourceMappingURL=AWSKinesisProvider.js.map"]},"metadata":{},"sourceType":"module"}